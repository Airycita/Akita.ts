"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Interpreter=void 0;const tslib_1=require("tslib"),compiler_1=require("./compiler"),container_1=require("./container"),fields_1=require("./fields"),data_1=require("./data"),lodash_1=tslib_1.__importDefault(require("lodash")),fs_1=tslib_1.__importDefault(require("fs"));class Interpreter{functions;compiler;constructor(){this.compiler=new compiler_1.Compiler(""),this.functions=[],this.load(),this.compiler.set_functions(this.functions.map(function(e){return e.data.name}))}fields(e,t=0,r=!0){return e.func.fields?.slice(t)?.map(e=>r?e.value.unescape()?.trim():e.value.trim())||[]}async resolve_fields(t,r=0,a=void 0){for(let e=r;e<t.func?.fields?.length&&e!=a;e++)t.func=await this.resolve_field(t,e);return t.func}async resolve_field(e,t){if(e.func?.fields?.[t])for(const i of e.func.fields[t].overs){var r,a=e.interpreter.functions.find(e=>e.data.name==i.name);a&&(i.resolve_fields=this.resolve_fields,i.resolve_field=this.resolve_field,r={...e,func:i,code:e.func.fields[t].value},(a=await a.code(r))?.code)&&e.func?.inside&&e.func.fields&&(e.func.fields[t].value=a.code,e.func.inside=e.func.fields.map(e=>e.value).join(";"),e.func.total=`${e.func.name}[${e.func.inside}]`,e.break=r.break,e.metadata=r.metadata)}return e.func}async parse(t,r,a){if(t){this.compiler.set_code(t),this.compiler.match();let e={metadata:lodash_1.default.merge({ctn:(new container_1.Container).setInstance(r?.metadata?.ctx?.data),parent:r?.metadata?.parent||null,yields:r?.metadata?.yields||{},vars:r?.metadata?.vars||{}},r?.metadata),code:this.compiler.result||"",compiler:this.compiler,interpreter:this,break:!!r?.break,func:{},client:a};for(const i of Object.values(this.compiler.matched).reverse()){if(e.break)break;e=await this.run_function(i,new data_1.That(e,new fields_1.Fields(e)))||e}return e}}async run_function(t,e){try{var r,a=this.functions.find(e=>e.data.name==t.name);return a&&(t.resolve_fields=this.resolve_fields,t.resolve_field=this.resolve_field,e.data.func=t,(r=await a.code.apply(e,[e.data]))?.code)&&(e.data.code=r.code.trim()||""),e.data}catch(r){return console.log(r),e.data.client?.emit("functionError",r,e),e.data}}async _(t){if(t.fields)for(let e=0;e<t.fields.length;e++)for(var r of t.fields[e].overs)await this._(r),t.fields[e].value=t.fields[e].value.replaceAll(r.id,r.total),t.inside=t.inside?.replaceAll(r.id,r.total),t.total=t.total.replaceAll(r.id,r.total)}addFunction(e){this.functions[this.functions.length]=e,this.compiler.set_functions(this.functions.map(function(e){return e.data.name})),this.functions.sort((e,t)=>t.data.name.length-e.data.name.length)}load(){var e=__dirname.replace("classes","functions");for(const r of fs_1.default.readdirSync(e))for(const a of fs_1.default.readdirSync(`${e}/${r}/`)){var t=require(`../functions/${r}/`+a).data;t&&this.addFunction(t)}String.prototype.unescape=function(){return this.replace(/@at/gi,"@").replace(/@left/gi,"[").replace(/@right/gi,"]").replace(/@semi/gi,";").replace(/@colon/gi,":").replace(/@equal/gi,"=").replace(/@or/gi,"||").replace(/@and/gi,"&&").replace(/@higher/gi,">").replace(/@lower/gi,"<").replace(/@left_parent/gi,")").replace(/@right_parent/gi,"(").replace(/@dollar/gi,"$")},String.prototype.escape=function(){return this.replace(/@/g,"@at").replace(/\]/g,"@right").replace(/\[/g,"@left").replace(/;/g,"@semi").replace(/:/g,"@colon").replace(/=/g,"@equal").replace(/\|\|/g,"@or").replace(/&&/g,"@and").replace(/>/g,"@higher").replace(/</g,"@lower").replace(/\$/g,"@dollar")},String.prototype.asyncReplace=function(t,e){let r=this,a=[];try{return"function"==typeof e?(r.replace(t,function(){return a.push(e.apply(void 0,arguments)),""}),Promise.all(a).then(function(e){return r.replace(t,()=>e.shift())})):Promise.resolve(this.replace(t,e))}catch(e){return Promise.reject(e)}}}}exports.Interpreter=Interpreter;